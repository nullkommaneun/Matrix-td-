<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Career Hub â€” Web Prototype</title>
<style>
  :root {
    --bg: #0a0d0a;
    --panel: #121515;
    --neon: #00ff88;
    --text: #b8f1d9;
    --muted: #7bc6a7;
    --danger: #ff4d4d;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    background: var(--bg);
    color: var(--text);
  }
  h1,h2,h3 { margin: 0.2rem 0 0.6rem; color: var(--neon); }
  .wrap { padding: 16px; max-width: 1400px; margin: 0 auto; }
  .hidden { display: none !important; }

  /* Retro Panel */
  .panel {
    border: 1px solid var(--neon);
    background: linear-gradient(135deg, rgba(18,21,21,0.95), rgba(18,21,21,0.9)), 
                repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0 2px, rgba(0,0,0,0.04) 2px 4px);
    padding: 12px;
    border-radius: 6px;
    position: relative;
  }
  .panel:before, .panel:after {
    content: "";
    position: absolute;
    width: 6px; height: 6px;
    background: var(--bg);
    border: 1px solid var(--neon);
    border-radius: 50%;
  }
  .panel:before { top: -4px; left: -4px; }
  .panel:after  { bottom: -4px; right: -4px; }

  /* Layout */
  .row { display: grid; gap: 12px; }
  .row.cols-2 { grid-template-columns: 1fr 1fr; }
  .row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  .header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px;
  }

  /* Buttons/Inputs */
  button, input, select, textarea {
    font: inherit; color: var(--text); background: var(--panel); border: 1px solid var(--neon);
    border-radius: 4px; padding: 6px 10px;
  }
  button { cursor: pointer; }
  button.primary { background: var(--neon); color: #000; border-color: var(--neon); }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  .inline { display: inline-flex; align-items: center; gap: 6px; }
  .muted { color: var(--muted); }
  .danger { color: var(--danger); }

  .stat-row { display: grid; grid-template-columns: 140px 36px 50px 36px; gap: 8px; align-items: center; margin: 6px 0; }
  .log {
    height: 60vh; overflow: auto; padding-right: 6px; font-size: 13px; line-height: 1.25rem;
    scrollbar-color: var(--neon) transparent;
  }
  .option-card { border: 1px solid var(--neon); border-radius: 6px; padding: 8px; margin: 6px 0; }
  .tag { display: inline-block; font-size: 11px; padding: 2px 6px; border: 1px solid var(--neon); border-radius: 999px; margin-right: 6px; color: var(--muted); }
  .pill { border: 1px solid var(--neon); padding: 2px 6px; border-radius: 999px; font-size: 12px; color: var(--muted); }
  .grid-mini { display: grid; grid-template-columns: auto 1fr; column-gap: 8px; row-gap: 4px; }
  .kbd { border: 1px solid var(--neon); padding: 0 4px; border-radius: 4px; color: var(--muted); }
  .sep { height: 1px; background: linear-gradient(90deg, transparent, var(--neon), transparent); margin: 8px 0; opacity: .4;}
</style>
</head>
<body>
<div class="wrap">

  <!-- START SCREEN -->
  <section id="start-screen" class="">
    <h1>Welcome to the Career Hub!</h1>
    <div class="row cols-2">
      <div class="panel">
        <h3>Background</h3>
        <div class="grid-mini" style="align-items:center;">
          <div>Herkunft</div>
          <div class="inline">
            <span id="bg-name"></span>
            <button id="bg-random">ðŸŽ² Random</button>
          </div>

          <div>Geschlecht</div>
          <div class="inline">
            <span id="gender-label">Divers</span>
            <button id="gender-toggle">Toggle</button>
          </div>

          <div>Alter</div>
          <div class="inline">
            <button id="age-minus">âˆ’</button>
            <span id="age-val" style="display:inline-block; width:48px; text-align:center;">18</span>
            <button id="age-plus">+</button>
          </div>

          <div>Pfad</div>
          <div>
            <select id="path-select">
              <option value="Ausbildung">Ausbildung</option>
              <option value="Universitaet">UniversitÃ¤t</option>
              <option value="Freelancer">Freelancer</option>
            </select>
          </div>

          <div>Seed (optional)</div>
          <div><input id="seed-input" placeholder="z.â€¯B. 12345" style="width: 100%;"/></div>
        </div>
      </div>

      <div class="panel">
        <h3>Stats â€“ Punkte Ã¼brig: <span id="pts-left">10</span></h3>
        <div class="stat-row">
          <div>Appearance</div>
          <button data-stat="Appearance" data-delta="-1">âˆ’</button>
          <div id="stat-Appearance" style="text-align:center;">2</div>
          <button data-stat="Appearance" data-delta="1">+</button>
        </div>
        <div class="stat-row">
          <div>Physique</div>
          <button data-stat="Physique" data-delta="-1">âˆ’</button>
          <div id="stat-Physique" style="text-align:center;">2</div>
          <button data-stat="Physique" data-delta="1">+</button>
        </div>
        <div class="stat-row">
          <div>Intellect</div>
          <button data-stat="Intellect" data-delta="-1">âˆ’</button>
          <div id="stat-Intellect" style="text-align:center;">2</div>
          <button data-stat="Intellect" data-delta="1">+</button>
        </div>
        <div class="stat-row">
          <div>Luck</div>
          <button data-stat="Luck" data-delta="-1">âˆ’</button>
          <div id="stat-Luck" style="text-align:center;">2</div>
          <button data-stat="Luck" data-delta="1">+</button>
        </div>
      </div>
    </div>

    <div style="margin-top:10px;">
      <button id="confirm-btn" class="primary" disabled>Confirm</button>
      <span class="muted">Verteile alle Punkte, um zu starten.</span>
    </div>
  </section>

  <!-- GAME SCREEN -->
  <section id="game-screen" class="hidden">
    <div class="header">
      <h2>Career Hub</h2>
      <div class="inline">
        <button id="btn-refresh">Optionen aktualisieren</button>
        <button id="btn-exit">Freiwillig beenden</button>
        <button id="btn-restart">Neustart</button>
      </div>
    </div>

    <div class="row cols-3">
      <div class="panel">
        <h3>Optionen <span class="muted">(safe / medium / hard)</span></h3>
        <div id="options"></div>
      </div>

      <div class="panel">
        <h3>Ereignisâ€‘Log</h3>
        <div class="log" id="log"></div>
      </div>

      <div class="panel">
        <h3>Status & Fortschritt</h3>
        <div id="status"></div>
        <div class="sep"></div>
        <h3>Cooldowns</h3>
        <div id="cooldowns"></div>
      </div>
    </div>
  </section>

  <!-- END SCREEN -->
  <section id="end-screen" class="hidden">
    <div class="panel" style="max-width:800px; margin: 20vh auto 0;">
      <h2 id="end-title">Ende</h2>
      <p id="end-summary" class="muted"></p>
      <div style="margin-top:12px;">
        <button id="btn-to-start" class="primary">ZurÃ¼ck zum Start</button>
      </div>
    </div>
  </section>
</div>

<script>
/* ---------- Seeded RNG (xmur3 + sfc32) ---------- */
function xmur3(str) {
  let h = 1779033703 ^ str.length;
  for (let i=0; i<str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = (h << 13) | (h >>> 19);
  }
  return function() {
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    h ^= h >>> 16;
    return h >>> 0;
  };
}
function sfc32(a, b, c, d) {
  return function() {
    a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
    let t = (a + b) | 0;
    a = b ^ (b >>> 9);
    b = (c + (c << 3)) | 0;
    c = (c << 21) | (c >>> 11);
    d = (d + 1) | 0;
    t = (t + d) | 0;
    c = (c + t) | 0;
    return (t >>> 0) / 4294967296;
  }
}
function makeRngFromSeed(seedStr) {
  const seeder = xmur3(seedStr);
  return sfc32(seeder(), seeder(), seeder(), seeder());
}

/* ---------- Enums/Types ---------- */
const Stat = { Appearance:"Appearance", Physique:"Physique", Intellect:"Intellect", Luck:"Luck" };
const Perk = { Networker:"Networker", Workhorse:"Workhorse", Analytical:"Analytical", Stoic:"Stoic", Creative:"Creative", LuckyBreak:"LuckyBreak" };
const Path = { Ausbildung:"Ausbildung", Universitaet:"Universitaet", Freelancer:"Freelancer" };
const Risk = { Safe:"Safe", Medium:"Medium", Hard:"Hard" };

const BACKGROUNDS = ["Arbeiterfamilie","Akademisch","Einwanderer","SelbststÃ¤ndig","Land","Stadt"];

/* ---------- Helpers ---------- */
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const signStr = (n) => (n >= 0 ? "+"+n : ""+n);

function choiceByWeights(rng, weights) {
  const total = weights.reduce((a,b)=>a+b, 0);
  if (total <= 0) return -1;
  let t = rng() * total, cum = 0;
  for (let i=0;i<weights.length;i++){ cum += weights[i]; if (t <= cum) return i; }
  return weights.length - 1;
}

function d10(rng){ return 1 + Math.floor(rng()*10); }

function luckShift(luck, perks) {
  const shift = Math.min(2, Math.floor(luck/5));
  const lucky = (perks.has(Perk.LuckyBreak) && luck <= 8) ? 1 : 0;
  return shift + lucky;
}
function perkStatBonus(perks, def) {
  let bonus = 0;
  if (perks.has(Perk.Networker) && def.tags.includes("networking")) bonus += 2;
  if (perks.has(Perk.Analytical) && def.tags.includes("study")) bonus += 2;
  return bonus;
}
function applyPerkEconomy(perks, def, stressDelta, moneyDelta, xpGain) {
  let s = stressDelta, m = moneyDelta, x = xpGain;
  if (perks.has(Perk.Workhorse) && def.tags.includes("work")) { s = Math.trunc(s * 0.85); m = Math.trunc(m * 1.10); }
  if (perks.has(Perk.Stoic) && s > 0) s = Math.trunc(s * 0.90);
  if (perks.has(Perk.Creative) && def.tags.includes("creative")) x = Math.trunc(x * 1.10);
  return [s, m, x];
}
function successProbability(state, def, dc) {
  const baseStat = state.stats[def.stat];
  const statBonus = perkStatBonus(state.perks, def);
  const ls = luckShift(state.stats.Luck, state.perks);
  let successes = 0;
  for (let r=1;r<=10;r++){
    const total = baseStat + statBonus + r + ls;
    if (total >= dc) successes++;
  }
  return successes * 10; // in %
}

/* ---------- Content ---------- */
function makeActions() {
  const list = [];
  const A = (o) => ({ // Action factory with defaults
    cooldown: 0, tags: [], pathRestriction: null,
    prereq: ()=>true,
    onSuccess: ()=>{}, onFailure: ()=>{},
    ...o
  });

  // ---- General (>=15) ----
  list.push(A({ id:"rest_deep", name:"Erholen (Tiefenentspannung)",
    desc:"AtemÃ¼bungen und Reset.", baseDC:0, stat:Stat.Physique,
    energyCost:-20, stressDelta:-25, moneyDelta:0, xpGain:0, tags:["rest"] }));

  list.push(A({ id:"focus_meditation", name:"Fokus: Meditation",
    desc:"10 Minuten Klarheit.", baseDC:0, stat:Stat.Physique,
    energyCost:-5, stressDelta:-15, moneyDelta:0, xpGain:0, tags:["rest"] }));

  list.push(A({ id:"learn_basics", name:"Lernen: Grundlagen",
    desc:"Struktur, Fokus, Notizen.", baseDC:7, stat:Stat.Intellect,
    energyCost:15, stressDelta:8, moneyDelta:0, xpGain:12, tags:["study"] }));

  list.push(A({ id:"learn_advanced", name:"Lernen: Fortgeschritten",
    desc:"Knifflige Inhalte meistern.", baseDC:9, stat:Stat.Intellect,
    energyCost:20, stressDelta:10, moneyDelta:0, xpGain:18, tags:["study","milestone-setup"] }));

  list.push(A({ id:"softskills_ws", name:"Workshop: Soft Skills",
    desc:"Kommunikation & Konflikt.", baseDC:8, stat:Stat.Appearance,
    energyCost:15, stressDelta:8, moneyDelta:0, xpGain:10, tags:["networking"] }));

  list.push(A({ id:"gym_training", name:"Trainieren: Basisfitness",
    desc:"Kraft & Haltung.", baseDC:7, stat:Stat.Physique,
    energyCost:25, stressDelta:-5, moneyDelta:0, xpGain:6, tags:["health"] }));

  list.push(A({ id:"part_time_job", name:"Arbeiten: Nebenjob",
    desc:"Routinearbeit gegen Cash.", baseDC:8, stat:Stat.Intellect,
    energyCost:20, stressDelta:12, moneyDelta:120, xpGain:8, tags:["work"] }));

  list.push(A({ id:"network_meetup", name:"Netzwerken: Meetup",
    desc:"Kontakte knÃ¼pfen.", baseDC:8, stat:Stat.Appearance,
    energyCost:10, stressDelta:10, moneyDelta:-10, xpGain:10, tags:["networking","milestone-setup"] }));

  list.push(A({ id:"network_linkedin", name:"Netzwerken: Outreach",
    desc:"3 gezielte Nachrichten.", baseDC:7, stat:Stat.Appearance,
    energyCost:8, stressDelta:8, moneyDelta:0, xpGain:8, tags:["networking"] }));

  list.push(A({ id:"portfolio_site", name:"Projekt: Portfolioâ€‘Seite",
    desc:"Deine Arbeit sichtbar machen.", baseDC:8, stat:Stat.Intellect,
    energyCost:20, stressDelta:12, moneyDelta:0, xpGain:18, tags:["creative","milestone-setup"] }));

  list.push(A({ id:"oss_pr", name:"Projekt: Openâ€‘Source PR",
    desc:"Kleiner Fix mit Review.", baseDC:9, stat:Stat.Intellect,
    energyCost:18, stressDelta:10, moneyDelta:0, xpGain:20, tags:["creative","milestone-setup"] }));

  list.push(A({ id:"online_cert", name:"Zertifikat: Onlineâ€‘Kurs",
    desc:"KompaktprÃ¼fung mit Badge.", baseDC:9, stat:Stat.Intellect,
    energyCost:22, stressDelta:12, moneyDelta:-50, xpGain:22, tags:["certificate"] ,
    onSuccess: (s)=> s.certificates.add("Onlineâ€‘Kurs") }));

  list.push(A({ id:"pitch_idea", name:"Pitch: Idee vorstellen",
    desc:"Kurz & knackig.", baseDC:10, stat:Stat.Appearance,
    energyCost:12, stressDelta:15, moneyDelta:150, xpGain:14, tags:["networking","milestone-setup"] }));

  list.push(A({ id:"public_speaking", name:"Auftritt: Kurzvortrag",
    desc:"5â€‘Minuten Lightning Talk.", baseDC:10, stat:Stat.Appearance,
    energyCost:15, stressDelta:18, moneyDelta:0, xpGain:20, tags:["networking"] }));

  list.push(A({ id:"time_mgmt", name:"Training: Zeitmanagement",
    desc:"PrioritÃ¤ten & Kanban.", baseDC:7, stat:Stat.Intellect,
    energyCost:10, stressDelta:6, moneyDelta:0, xpGain:10, tags:["study"] }));

  // Bonus aus Mini-Aufgabe (Beispiel)
  list.push(A({ id:"tech_blog", name:"Projekt: Techâ€‘Blogartikel",
    desc:"Kurzer, lehrreicher Post.", baseDC:9, stat:Stat.Intellect,
    energyCost:16, stressDelta:10, moneyDelta:0, xpGain:20, tags:["creative","milestone-setup"], cooldown:2 }));

  // ---- Ausbildung ----
  list.push(A({ id:"apprentice_intern", name:"Ausbildung: Praktikum",
    desc:"Reinschnuppern in den Betrieb.", baseDC:8, stat:Stat.Intellect,
    energyCost:18, stressDelta:10, moneyDelta:80, xpGain:12, tags:["work","apprentice","milestone-setup"],
    pathRestriction: Path.Ausbildung }));

  list.push(A({ id:"vocational_exam", name:"Ausbildung: GesellenprÃ¼fung",
    desc:"Theorie & Praxis.", baseDC:10, stat:Stat.Intellect,
    energyCost:22, stressDelta:14, moneyDelta:-30, xpGain:24, tags:["certificate"],
    pathRestriction: Path.Ausbildung,
    prereq: (s)=> s.xp >= 40,
    onSuccess: (s)=> s.certificates.add("Gesellenbrief") }));

  list.push(A({ id:"shop_floor_project", name:"Ausbildung: Betriebsprojekt",
    desc:"Eigenverantwortlich umsetzen.", baseDC:9, stat:Stat.Intellect,
    energyCost:20, stressDelta:12, moneyDelta:160, xpGain:20, tags:["work","milestone-setup"],
    pathRestriction: Path.Ausbildung }));

  list.push(A({ id:"master_school", name:"Ausbildung: Meisterschuleâ€‘Projekt",
    desc:"Komplexes PraxisstÃ¼ck.", baseDC:11, stat:Stat.Intellect,
    energyCost:25, stressDelta:16, moneyDelta:300, xpGain:30, tags:["work","milestone-setup"],
    pathRestriction: Path.Ausbildung }));

  // ---- UniversitÃ¤t ----
  list.push(A({ id:"uni_module_exam", name:"Uni: ModulprÃ¼fung",
    desc:"Klausur & Ãœbungsblatt.", baseDC:9, stat:Stat.Intellect,
    energyCost:18, stressDelta:12, moneyDelta:0, xpGain:22, tags:["study","certificate"],
    pathRestriction: Path.Universitaet,
    onSuccess:(s)=> s.certificates.add("Modulschein") }));

  list.push(A({ id:"student_tutor", name:"Uni: Tutorium leiten",
    desc:"Ãœbungen erklÃ¤ren.", baseDC:8, stat:Stat.Appearance,
    energyCost:12, stressDelta:10, moneyDelta:80, xpGain:16, tags:["networking"],
    pathRestriction: Path.Universitaet }));

  list.push(A({ id:"publish_paper", name:"Uni: Paper verÃ¶ffentlichen",
    desc:"Kurzbeitrag einreichen.", baseDC:10, stat:Stat.Intellect,
    energyCost:22, stressDelta:15, moneyDelta:0, xpGain:28, tags:["creative","milestone-setup"],
    pathRestriction: Path.Universitaet }));

  list.push(A({ id:"conf_talk", name:"Uni: Konferenzâ€‘Talk",
    desc:"Vor Fachpublikum.", baseDC:11, stat:Stat.Appearance,
    energyCost:20, stressDelta:18, moneyDelta:150, xpGain:26, tags:["networking","conf_talk"],
    pathRestriction: Path.Universitaet }));

  list.push(A({ id:"thesis_project", name:"Uni: Abschlussarbeit",
    desc:"Eigenes Thema ausarbeiten.", baseDC:10, stat:Stat.Intellect,
    energyCost:24, stressDelta:16, moneyDelta:0, xpGain:32, tags:["milestone-setup"],
    pathRestriction: Path.Universitaet,
    prereq: (s)=> s.certificates.has("Modulschein") && s.xp >= 60 }));

  // ---- Freelancer ----
  list.push(A({ id:"client_acq", name:"Freelance: Kundenakquise",
    desc:"Erstes Angebot platzieren.", baseDC:9, stat:Stat.Appearance,
    energyCost:15, stressDelta:12, moneyDelta:0, xpGain:18, tags:["networking","milestone-setup"],
    pathRestriction: Path.Freelancer }));

  list.push(A({ id:"small_contract", name:"Freelance: Kleiner Auftrag",
    desc:"Landingâ€‘Page/Logo/etc.", baseDC:8, stat:Stat.Intellect,
    energyCost:18, stressDelta:12, moneyDelta:180, xpGain:18, tags:["work"],
    pathRestriction: Path.Freelancer }));

  list.push(A({ id:"brand_build", name:"Freelance: Marke aufbauen",
    desc:"Naming, CI, KanÃ¤le.", baseDC:9, stat:Stat.Intellect,
    energyCost:20, stressDelta:12, moneyDelta:0, xpGain:20, tags:["creative"],
    pathRestriction: Path.Freelancer }));

  list.push(A({ id:"big_project", name:"Freelance: GroÃŸprojekt",
    desc:"Festpreis mit Scope.", baseDC:11, stat:Stat.Intellect,
    energyCost:25, stressDelta:18, moneyDelta:600, xpGain:34, tags:["work","milestone-setup"],
    pathRestriction: Path.Freelancer, prereq:(s)=> s.xp >= 60 }));

  list.push(A({ id:"retainer_deal", name:"Freelance: Retainerâ€‘Vertrag",
    desc:"Monatliche Betreuung.", baseDC:10, stat:Stat.Appearance,
    energyCost:18, stressDelta:14, moneyDelta:350, xpGain:24, tags:["work","milestone-setup"],
    pathRestriction: Path.Freelancer }));

  return list;
}

function makeMilestones() {
  return [
    // Ausbildung
    { id:"appr_start", name:"Praktikant", desc:"Praktikum gemeistert.", path:Path.Ausbildung, isPinnacle:false,
      requirements:(s)=> (s.successTags.get("apprentice")||0) >= 1,
      rewards:(s)=> s.money += 200 },
    { id:"journeyman", name:"Geselle", desc:"Gesellenbrief erhalten.", path:Path.Ausbildung, isPinnacle:false,
      requirements:(s)=> s.certificates.has("Gesellenbrief") && s.stats.Intellect >= 6,
      rewards:(s)=> s.perks.add(Perk.Workhorse) },
    { id:"meister", name:"Meister", desc:"Meisterschule abgeschlossen.", path:Path.Ausbildung, isPinnacle:true,
      requirements:(s)=> (s.successTags.get("milestone-setup")||0) >= 5 && s.xp >= 120,
      rewards:(s)=> s.money += 1000 },

    // UniversitÃ¤t
    { id:"bachelor_phase", name:"Bachelorâ€‘Phase", desc:"2 ModulprÃ¼fungen.", path:Path.Universitaet, isPinnacle:false,
      requirements:(s)=> [...s.certificates].filter(c=>c==="Modulschein").length >= 2,
      rewards:(s)=> s.money += 100 },
    { id:"research", name:"Forschung", desc:"Paper verÃ¶ffentlicht.", path:Path.Universitaet, isPinnacle:false,
      requirements:(s)=> (s.successTags.get("creative")||0) >= 1,
      rewards:(s)=> s.xp += 20 },
    { id:"thesis", name:"Abschluss", desc:"Abschlussarbeit geschafft.", path:Path.Universitaet, isPinnacle:true,
      requirements:(s)=> (s.successTags.get("milestone-setup")||0) >= 4 && s.xp >= 100,
      rewards:(s)=> s.perks.add(Perk.Analytical) },

    // Freelancer
    { id:"first_client", name:"Erster Kunde", desc:"Ersten Auftrag erfÃ¼llt.", path:Path.Freelancer, isPinnacle:false,
      requirements:(s)=> (s.successTags.get("work")||0) >= 1,
      rewards:(s)=> s.money += 150 },
    { id:"brand", name:"Marke etabliert", desc:"Marke aufgebaut.", path:Path.Freelancer, isPinnacle:false,
      requirements:(s)=> (s.successTags.get("creative")||0) >= 1 && s.xp >= 60,
      rewards:(s)=> s.perks.add(Perk.Creative) },
    { id:"retainer_big", name:"Retainer & GroÃŸprojekt", desc:"Stabile Pipeline.", path:Path.Freelancer, isPinnacle:true,
      requirements:(s)=> (s.successTags.get("milestone-setup")||0) >= 4 && s.xp >= 110,
      rewards:(s)=> s.money += 800 },
  ];
}

/* ---------- Game Engine ---------- */
function createState(meta, stats, perks, path, seedStr) {
  const rng = makeRngFromSeed(seedStr);
  return {
    meta, stats, perks, path, rng,
    energy: 100, stress: 0, money: 0, xp: 0,
    cooldowns: new Map(),
    sinceSeen: new Map(),
    successTags: new Map(),
    certificates: new Set(),
    history: [],
    milestonesAchieved: new Set(),
    ended: false, endTitle: "", endSummary: ""
  };
}

function pickOptions(state, pool) {
  const risks = [Risk.Safe, Risk.Medium, Risk.Hard];
  const targets = new Map([
    [Risk.Safe,   6 + Math.floor(state.rng()*2)], // 6..7
    [Risk.Medium, 8 + Math.floor(state.rng()*2)], // 8..9
    [Risk.Hard,  10 + Math.floor(state.rng()*2)]  // 10..11
  ]);
  const out = [];
  const X_NEU = 5;

  // Age all sinceSeen counters
  pool.forEach(def=>{
    state.sinceSeen.set(def.id, (state.sinceSeen.get(def.id) ?? (X_NEU+1)) + 1);
  });

  for (const risk of risks) {
    const target = targets.get(risk);
    const candidates = pool.filter(def=>{
      const cd = state.cooldowns.get(def.id) ?? 0;
      const pathOK = (def.pathRestriction === null) || (def.pathRestriction === state.path);
      return pathOK && def.prereq(state) && cd <= 0;
    });
    if (candidates.length === 0) continue;

    const weights = candidates.map(def=>{
      const fitGrad = 1 - (Math.abs(def.baseDC - target)/5);
      let w = Math.max(0, Math.min(1, fitGrad));
      if (state.stress >= 70 && def.tags.includes("rest")) w *= 1.5;
      if (state.energy <= 30 && def.energyCost >= 25) w *= 0.6;
      if (def.tags.includes("milestone-setup")) w *= 1.25;
      const age = state.sinceSeen.get(def.id) ?? (X_NEU+1);
      w *= (age > X_NEU) ? 1.2 : 0.8;
      return w;
    });
    let idx = choiceByWeights(state.rng, weights);
    if (idx >= 0) {
      const chosen = candidates[idx];
      state.sinceSeen.set(chosen.id, 0);
      out.push({ def: chosen, risk, targetDC: target });
    }
  }

  // Fallback auffÃ¼llen (immer genau 3 Optionen)
  const ensureRest = (alreadyIds)=>{
    const rest = pool.find(a=>a.id==="rest_deep");
    if (!rest) return null;
    if (!alreadyIds.has(rest.id)) return { def: rest, risk: Risk.Safe, targetDC: 0 };
    const med = pool.find(a=>a.id==="focus_meditation");
    if (med && !alreadyIds.has(med.id)) return { def: med, risk: Risk.Safe, targetDC: 0 };
    return null;
  };
  const ids = new Set(out.map(o=>o.def.id));
  while (out.length < 3) {
    const extra = ensureRest(ids);
    if (!extra) break;
    out.push(extra); ids.add(extra.def.id);
  }
  return out;
}

function applyAction(state, option) {
  const def = option.def;

  // Sicherheitsnetz
  const last = state.history.slice(-20);
  const succRate = last.length ? (last.filter(x=>x).length / last.length) : 1.0;
  const safety = (succRate < 0.40) ? 1 : 0;

  const baseStat = state.stats[def.stat];
  const statBonus = perkStatBonus(state.perks, def);
  const ls = luckShift(state.stats.Luck, state.perks);
  const roll = d10(state.rng);
  const total = baseStat + statBonus + roll + ls;
  const dcEff = Math.max(0, def.baseDC - safety);
  const success = total >= dcEff;

  // Wirtschaft mit Perks
  const [stressAdj, moneyAdj, xpAdj] = applyPerkEconomy(state.perks, def, def.stressDelta, def.moneyDelta, def.xpGain);

  // Ressourcen (Kosten gelten unabhÃ¤ngig vom Erfolg)
  state.energy = clamp(state.energy - def.energyCost, 0, 100); // negative energyCost == Erholung
  state.stress = clamp(state.stress + stressAdj, 0, 100);
  state.money += moneyAdj;
  state.xp += xpAdj;

  // Cooldowns: setzen & alle runterzÃ¤hlen (Aktionen-basiert)
  if (def.cooldown && def.cooldown > 0) state.cooldowns.set(def.id, def.cooldown);
  for (const [k,v] of [...state.cooldowns.entries()]) {
    state.cooldowns.set(k, Math.max(0, v - 1));
  }

  // Tags zÃ¤hlen (nur bei Erfolg)
  def.tags.forEach(tag=>{
    const cur = state.successTags.get(tag) ?? 0;
    state.successTags.set(tag, cur + (success ? 1 : 0));
  });

  // Callbacks
  if (success) def.onSuccess(state); else def.onFailure(state);

  // Ende prÃ¼fen
  if (state.stress >= 100) {
    endGame(state, "Burnout", "Stress bei 100. Analyse: Du hast zu wenig Erholung eingeplant.");
  } else {
    checkMilestones(state);
  }

  state.history.push(success);
  if (state.history.length > 50) state.history.shift();

  const prob = successProbability(state, def, def.baseDC); // Anzeige ohne Safety
  const parts = [];
  parts.push(`Aktion: ${def.name} [${option.risk.toLowerCase?.() || option.risk}]`);
  parts.push(`Kosten(E/S/G): ${def.energyCost}/${def.stressDelta}/${def.moneyDelta}, DC=${def.baseDC}, Stat=${def.stat}, Erfolgsâ€‘%â‰ˆ${prob}%`);
  let msg = `W10=${roll}, Luckâ€‘Shift +${ls}, Stat ${def.stat} ${baseStat}`;
  if (statBonus) msg += ` (+Perk ${statBonus})`;
  if (safety === 1) msg += `, Sicherheitsnetz âˆ’1 DC`;
  msg += ` â†’ Summe=${total} ${success ? "â‰¥" : "<"} DC ${dcEff} â†’ ${success ? "Erfolg" : "Misserfolg"}; `;
  msg += `Î”: Energie ${signStr(-def.energyCost)}, Stress ${signStr(stressAdj)}, Geld ${signStr(moneyAdj)}, XP +${xpAdj}.`;
  return `${parts.join(", ")}. ${msg}`;
}

function checkMilestones(state) {
  const ms = makeMilestones().filter(m => m.path === state.path && !state.milestonesAchieved.has(m.id));
  for (const m of ms) {
    if (m.requirements(state)) {
      m.rewards(state);
      state.milestonesAchieved.add(m.id);
      if (m.isPinnacle) {
        endGame(state, `Pinnacle erreicht: ${m.name}`, legacySummary(state));
        break;
      }
    }
  }
}

function legacySummary(state) {
  let rankScore = 0;
  if (["meister","thesis","retainer_big"].some(id => state.milestonesAchieved.has(id))) rankScore = 3000;
  else if (state.milestonesAchieved.size >= 2) rankScore = 2000;
  else if (state.milestonesAchieved.size >= 1) rankScore = 1000;

  const wealth = Math.trunc(state.money / 10);
  const milestones = state.milestonesAchieved.size * 100;
  const rare = (state.successTags.get("conf_talk") || 0) > 0 ? 200 : 0;
  const wellbeing = (100 - state.stress) * 5;
  const score = rankScore + wealth + milestones + rare + wellbeing;

  return `Legacyâ€‘Score: ${score}  (Rang=${rankScore}, VermÃ¶gen/10=${wealth}, Milestones=${milestones}, Seltenes=${rare}, Wohlbefinden=${wellbeing}).`;
}

function endGame(state, title, summary) {
  state.ended = true; state.endTitle = title; state.endSummary = summary;
}

/* ---------- UI Binding ---------- */
const elStart = document.getElementById("start-screen");
const elGame  = document.getElementById("game-screen");
const elEnd   = document.getElementById("end-screen");

const elBgName = document.getElementById("bg-name");
const elBgRandom = document.getElementById("bg-random");
const elGender = document.getElementById("gender-label");
const elGenderToggle = document.getElementById("gender-toggle");
const elAgeVal = document.getElementById("age-val");
const elAgeMinus = document.getElementById("age-minus");
const elAgePlus = document.getElementById("age-plus");
const elPtsLeft = document.getElementById("pts-left");
const elSeedInput = document.getElementById("seed-input");
const elPathSelect = document.getElementById("path-select");
const elConfirm = document.getElementById("confirm-btn");

const elOptions = document.getElementById("options");
const elLog = document.getElementById("log");
const elStatus = document.getElementById("status");
const elCooldowns = document.getElementById("cooldowns");

const elRefresh = document.getElementById("btn-refresh");
const elExit = document.getElementById("btn-exit");
const elRestart = document.getElementById("btn-restart");

const elEndTitle = document.getElementById("end-title");
const elEndSummary = document.getElementById("end-summary");
const elToStart = document.getElementById("btn-to-start");

/* Start State (pre-game) */
const pre = {
  gender: "Divers",
  age: 18,
  bgIdx: 0,
  stats: { Appearance:2, Physique:2, Intellect:2, Luck:2 },
  pointsLeft: 10,
  path: Path.Ausbildung
};

let GAME = null;
const ACTIONS = makeActions();

function updateStartUI() {
  elBgName.textContent = BACKGROUNDS[pre.bgIdx];
  elGender.textContent = pre.gender;
  elAgeVal.textContent = pre.age;
  elPtsLeft.textContent = pre.pointsLeft;
  document.getElementById("stat-Appearance").textContent = pre.stats.Appearance;
  document.getElementById("stat-Physique").textContent  = pre.stats.Physique;
  document.getElementById("stat-Intellect").textContent = pre.stats.Intellect;
  document.getElementById("stat-Luck").textContent      = pre.stats.Luck;
  elConfirm.disabled = pre.pointsLeft !== 0;
}

function toStart() {
  // reset pre
  pre.gender = "Divers"; pre.age = 18; pre.bgIdx = 0; pre.pointsLeft = 10; pre.path = Path.Ausbildung;
  pre.stats = { Appearance:2, Physique:2, Intellect:2, Luck:2 };
  elSeedInput.value = "";
  elPathSelect.value = pre.path;
  updateStartUI();
  elStart.classList.remove("hidden");
  elGame.classList.add("hidden");
  elEnd.classList.add("hidden");
  elLog.innerHTML = "";
}

function startGame() {
  const seed = (elSeedInput.value || (""+Date.now())).trim();
  GAME = createState(
    { gender: pre.gender, age: pre.age, background: BACKGROUNDS[pre.bgIdx] },
    { ...pre.stats },
    new Set(), // Start ohne Perk
    pre.path,
    seed
  );
  elStart.classList.add("hidden");
  elGame.classList.remove("hidden");
  refreshOptions();
  renderStatus();
  renderCooldowns();
}

function renderStatus() {
  const s = GAME;
  elStatus.innerHTML = `
    <div>Energie: <strong>${s.energy}</strong> &nbsp; Stress: <strong>${s.stress}</strong> &nbsp; Geld: <strong>${s.money}â‚¬</strong> &nbsp; XP: <strong>${s.xp}</strong></div>
    <div>Pfad: <span class="pill">${s.path}</span></div>
    <div>Perks: ${s.perks.size ? [...s.perks].join(", ") : "â€“"}</div>
    <div>Milestones: ${s.milestonesAchieved.size ? [...s.milestonesAchieved].join(", ") : "â€“"}</div>
    <div>Zertifikate: ${s.certificates.size ? [...s.certificates].join(", ") : "â€“"}</div>
  `;
}
function renderCooldowns() {
  const lines = [];
  for (const [k,v] of GAME.cooldowns.entries()) {
    if (v > 0) lines.push(`â€¢ ${k}: ${v} Aktionen`);
  }
  elCooldowns.innerHTML = lines.length ? lines.join("<br>") : "Keine.";
}
function refreshOptions() {
  const opts = pickOptions(GAME, ACTIONS);
  elOptions.innerHTML = "";
  for (const opt of opts) {
    elOptions.appendChild(optionCard(opt));
  }
}

function optionCard(opt) {
  const def = opt.def;
  const prob = successProbability(GAME, def, def.baseDC);
  const div = document.createElement("div");
  div.className = "option-card";
  const tags = def.tags.map(t=>`<span class="tag">${t}</span>`).join(" ");

  // FÃ¼r DurchfÃ¼hrbarkeit mÃ¼ssen wir die perkâ€‘adjusted Stresskosten kennen:
  const [stressAdj] = applyPerkEconomy(GAME.perks, def, def.stressDelta, def.moneyDelta, def.xpGain);
  const canAfford = (GAME.energy - def.energyCost) >= 0 && (GAME.stress + Math.max(0, stressAdj)) <= 100;

  div.innerHTML = `
    <div class="inline" style="justify-content:space-between;">
      <div><strong>${def.name}</strong> <span class="muted">[${opt.risk.toLowerCase?.() || opt.risk}]</span></div>
      <div>${tags}</div>
    </div>
    <div class="muted">${def.desc}</div>
    <div>Kosten: Energie ${def.energyCost < 0 ? "+"+(-def.energyCost) : def.energyCost} / Stress ${signStr(def.stressDelta)} / Geld ${signStr(def.moneyDelta)}
        &nbsp; | &nbsp; Belohnung: XP +${def.xpGain}</div>
    <div>DC=${def.baseDC} | Stat=${def.stat} | Erfolgsâ€‘%â‰ˆ${prob}%</div>
    <div style="margin-top:6px;"><button class="primary" ${canAfford ? "" : "disabled"}>AusfÃ¼hren</button>
      ${canAfford ? "" : `<span class="danger" style="margin-left:8px;">Nicht durchfÃ¼hrbar (Energie/Stress)</span>`}
    </div>
  `;
  const btn = div.querySelector("button");
  btn.addEventListener("click", ()=>{
    const entry = applyAction(GAME, opt);
    prependLog(entry);
    if (GAME.ended) {
      showEnd();
    } else {
      refreshOptions();
      renderStatus();
      renderCooldowns();
    }
  });
  return div;
}
function prependLog(line) {
  const p = document.createElement("div");
  p.textContent = "â€¢ " + line;
  elLog.prepend(p);
}

function showEnd() {
  elGame.classList.add("hidden");
  elEnd.classList.remove("hidden");
  elEndTitle.textContent = GAME.endTitle;
  elEndSummary.textContent = GAME.endSummary;
}

/* ---------- Event Wiring ---------- */
document.querySelectorAll('button[data-stat]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const stat = btn.getAttribute('data-stat');
    const delta = parseInt(btn.getAttribute('data-delta'), 10);
    const cur = pre.stats[stat];
    // +: nur wenn Punkte Ã¼brig, âˆ’: nur wenn >0
    if (delta > 0 && pre.pointsLeft <= 0) return;
    const nv = clamp(cur + delta, 0, 10);
    if (nv !== cur) {
      pre.stats[stat] = nv;
      pre.pointsLeft += (delta > 0 ? -1 : +1);
      pre.pointsLeft = clamp(pre.pointsLeft, 0, 10);
      updateStartUI();
    }
  });
});

elBgRandom.addEventListener('click', ()=>{
  pre.bgIdx = (pre.bgIdx + 1 + Math.floor(Math.random()*BACKGROUNDS.length)) % BACKGROUNDS.length;
  updateStartUI();
});
elGenderToggle.addEventListener('click', ()=>{
  pre.gender = pre.gender === "MÃ¤nnlich" ? "Weiblich" : (pre.gender === "Weiblich" ? "Divers" : "MÃ¤nnlich");
  updateStartUI();
});
elAgeMinus.addEventListener('click', ()=>{ pre.age = Math.max(10, pre.age - 1); updateStartUI(); });
elAgePlus.addEventListener('click', ()=>{ pre.age = Math.min(80, pre.age + 1); updateStartUI(); });
elPathSelect.addEventListener('change', (e)=>{ pre.path = e.target.value; });

elConfirm.addEventListener('click', startGame);
elRefresh.addEventListener('click', ()=>{ refreshOptions(); });
elExit.addEventListener('click', ()=>{
  endGame(GAME, "Freiwilliger Ausstieg", legacySummary(GAME));
  showEnd();
});
elRestart.addEventListener('click', ()=>{ toStart(); });
elToStart.addEventListener('click', ()=>{ toStart(); });

// init
toStart();
</script>
</body>
				</html>